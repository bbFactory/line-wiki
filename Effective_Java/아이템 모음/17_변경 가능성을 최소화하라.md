# 4장. 클래스와 인터페이스(p95~152)

## 아이템 17. 변경 가능성을 최소화하라(p105~113)

> **불변 클래스란 인스턴스의 내부 값을 수정할 수 없는 클래스다.** 불변 객체는 **생성된 시점의 상태를 파괴될 때까지 그대로 간직한다.** String, BigInteger, BigDecimal이 불변 클래스의 예시들이다. 불변 클래스는 가변 클래스보다 오류가 생길 여지가 적고, 스레드 안전하여 따로 동기화할 필요가 없다.

## 불변 클래스 정의 규칙

- **객체의 상태를 변경하는 메서드(변경자)를 제공하지 않는다.**
- **클래스의 확장을 막는다.** 
  - 상속을 막기 위해 **final 클래스를 선언**하거나,
  - 모든 생성자를 private 또는 package-private으로 만들고 **public 정적 팩터리를 제공**한다.
- **모든 필드를 final로 선언한다.** 
- **모든 필드를 private으로 선언한다.**
- **자신 외에는 내부의 가변 컴포넌트에 접근할 수 없도록 한다.** 클라이언트가 직접 객체 참조에 접근하지 못하게 생성자, 접근자, readObject 메서드(아이템 88) 모두에서 방어적 복사를 수행하자.

## 불변 클래스 인스턴스의 재활용

한 번 만들어진 불변 객체는 절대 훼손되지 않으므로 안심하고 공유할 수 있다. 같은 정보를 가진 불변 객체를 자주 사용한다면 이를 **재활용**하는 것이 좋다. 재활용(인스턴스 공유)은 가변 객체에 비해 객체 관리의 복잡도를 낮추고, **메모리 사용량과 가비지 컬렉션 비용을 줄여준다.** 

예를 들면 자주 쓰이는 값들을 **상수(public static final)**로 제공할 수 있다.

```java
public static final Complex ZERO = new Complex(0, 0);
public static final Complex ONE = new Complex(1, 0);
public static final Complex I = new Complex(0, 1);
```

더 나아가 자주 사용되는 인스턴스를 캐싱하는 **정적 팩터리**(아이템1)를 제공할 수 있다. 이는 같은 인스턴스의 중복 생성을 방지한다. 박싱된 기본 타입 클래스 전부와 BigInteger가 여기에 속한다.  

불변 클래스의 복제본은 처음부터 끝까지 원본 객체와 똑같은 정보를 가지므로 굳이 복사의 의미가 없다. 불변 클래스는 **clone 메서드나 복사 생성자(아이템 13)를 제공하지 않는 게 좋다.** 

## 불변 클래스의 이점

- 불변 클래스의 객체는 자유롭게 공유할 수 있고, 불변 객체끼리 **내부 데이터를 공유할 수 있다.** 불변 클래스 BigInteger의 negate 메서드는 크기가 같고 부호만 반대인 새로운 BigInteger를 생성한다. 이때 크기로 사용되는 int 배열 mag는 원본 인스턴스의 배열과 동일한 것이 사용된다.

  ```java
  final int[] mag; // int 배열 자체가 초기화 때의 값이 유지되는 불변 객체이다.
  ...
      
  /**
   * Returns a BigInteger whose value is {@code (-this)}.
   *
   * @return {@code -this}
   */
  public BigInteger negate() {
      return new BigInteger(this.mag, -this.signum);
  }
  ```

- 값이 바뀌지 않는 구성요소들로 이뤄진 객체라면 그 구조가 아무리 복잡하더라도 **불변식을 유지하기 훨씬 수월하다.** 예를 들어 불변 객체는 값이 바뀌지 않기 때문에 **맵의 키와 집합(Set)의 원소**로 사용하기에 좋다.

- **불변 객체는 그 자체로 실패 원자성을 제공한다**(아이템 76). 메서드에 포함된 예외가 발생하더라도 객체 상태가 메서드 호출 이전 상태와 동일하게 유지된다.

## 불변 클래스의 단점/ 주의할 점

- **아무리 작은 값이라도 값이 달라지면 반드시 독립된 객체로 만들어야 한다.** 값의 개수가 많은 경우라면 불변 객체 생성 비용이 많이 든다.
- **Serializable을 구현하는 불변 클래스**의 내부에 가변 객체를 참조하는 필드가 있다면 다음 메서드를 제공해야 한다.
  - readObject 또는 readResolve를 반드시 제공하거나,
  - ObjectOutputStream.writeUnshared와 ObjectInputStream.readUnshared 메서드를 사용해야 한다.
  - 그렇지 않으면 공격자가 이 클래스로부터 가변 인스턴스를 만들어낼 수 있다(이 주제는 아이템 88에서 다룬다).

**생성자는 불변식 설정이 모두 완료된, 초기화가 완벽히 끝난 상태의 객체를 생성해야 한다.** 확실한 이유가 없다면 **생성자와 정적 팩터리 외에는 그 어떤 초기화 메서드도 public으로 제공해서도 안 된다.**


