# Chapter 04. 스프링 시큐리티

소프트웨어 개발자로써 우리느 애플리케이션에 있는 정보를 보호하는 조치를 해야 한다. 앞으로 **스프링 시큐리티를 자동 구성** 하는 방법, **커스텀 사용자 스토리지** 를 정의하는 방법 등을 배우고, **커스텀 로그인 페이지** 를 만들어볼 것이다. 또한 **CSRF 공격** 을 막아보고, **사용자를 파악** 해보는 방법을 살펴볼 것이다.

## 4.1 스프링 시큐리티 활성화하기(p117~120)

스프링 애플리케이션의 보안에서 가장 먼저 할 일은 **스프링 부트 보안 스타터 의존성** 을 빌드 명세에 추가하는 것이다. 아래 pom.xml 파일에서 추가하는 첫 번째 `<dependency>` 항목은 스프링 부트 보안 스타터 의존성이고, 두 번째는 보안 테스트 의존성이다.

```xml
...
<dependencies>
	...
    <dependency>
    	<groupdId>org.springframework.boot</groupdId>
        <artifactId>spring-boot-starter-security</artifactId>
    </dependency>
    
    <dependency>
    	<gorupId>org.springframework.security</gorupId>
        <artifactId>spring-security-test</artifactId>
        <scope>test</scope>
    </dependency>
</dependencies>
```

놀랍게도 방금 추가한 의존성이 스프링 애플리케이션을 안전하게 하기 위해 필요한 전부이다. 애플리케이션이 시작되면 스프링이 우리 프로젝트의 classpath에 있는 스프링 시큐리티 라이브러리를 찾아 기본적인 보안 구성을 설정한다.

어떻게 설정해 주는지 확인하려면 애플리케이션을 시작한 후, 웹 브라우저에서 홈페이지(http://localhost:8080)이나 타코 디자인 페이지(http://localhost:8080/design)에 접속해 보자. 그러면 스프링 시큐리티에서 제공하는 HTTP 기본 인증 대화상자가 나타난다.

기본 인증 대화상자에서 Username 필드에 "user"라고 입력한다. Password는 무작위로 자동 생성되어 애플리케이션 로그 파일에 수록된다. STS를 사용하는 경우 콘솔 창에 다음과 같은 로그 항목이 나타난다.

```
Using generated security password: 6838886b-edb5-40d8-bc45-395ba25a79e4
```

뒤쪽 36자리의 비밀번호를 마우스로 선택하여 복사한 후 Password 필드에 붙여넣기 하고 Sign in 버튼을 클릭하면 로그인된다. 그러면 애플리케이션을 사용할 수 있는 권한이 부여되어 우리가 접속한 페이지가 나타난다. 스프링의 username(사용자 이름)은 사용자 id를 의미한다.

지금부터는 스프링 시큐리티의 보안 자동 구성이 어떻게 제공되는지 알아보자.

먼저 보안 스타터를 프로젝트 빌드 파일에 추가만 할 경우 다음의 보안 구성이 제공된다.

- 모든 HTTP 요청 경로는 인증(authentication) 되어야 한다.
- 어떤 특정 역할이나 권한이 없다.
- 로그인 페이지가 따로 없다.
- 스프링 시큐리티의 HTTP 기본 인증(앞서 했던 인증)을 사용해서 인증된다.
- 사용자는 user 이름으로 하나만 존재한다. 비밀번호는 암호화해준다.

타코 클라우드 애플리케이션을 비롯하여 자신만의 애플리케이션을 만들 땐 보안을 제대로 구축하기 위해 더 많은 작업이 필요하며, 최소한 다음 기능을 할 수 있도록 스프링 시큐리티를 구성해야 한다.

-  스프링 시큐리티의 HTTP 인증 대화상자 대신 우리의 로그인 페이지로 인증한다.
- 다수의 사용자를 제공하며, 새로운 타코 클라우드 고객이 사용자로 등록할 수 있는 페이지가 있어야 한다.
- 서로 다른 HTTP 요청 경로마다 서로 다른 보안 규칙을 적용한다. 예를 들어 홈페이지와 사용자 등록 페이지는 인증이 필요하지 않다.

위와 같은 보안 요구를 충족하기 위해서 스프링 자동-구성이 하는 것을 대체하는 작업을 해야 한다. 우선 한 명 이상의 사용자를 가질 수 있도록 타코 클라우드에 적합한 사용자 스토어(store)를 구성해보자.

## 4.2 스프링 시큐리티 구성하기(p120~123)

우선 자바 기반으로 기본 구성 클래스를 작성해보자.

```java
package tacos.security;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation
    	.authentication.builders.AuthenticationManagerBuilder;
import org.springframework.security.config.annotation
    	.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web
    	.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web
    	.configuration.WebSecurityConfigurerAdapter;

@Configuration
@EnableWebSecurity
public class SecurityConfig extends WebSecurityConfigurerAdapter {
    @Override
    protectesd void configure(HttpSecurity http) throws Exception {
        http
            .authorizeRequests()
            .antMatchers("/design", "/orders")
            .access("hasRole('ROLE_USER')")
            .antMatchers("/", "/**").access("permitAll")
            .and()
            .httpBasic();
    }
    
    @Override
    public void configure(AuthenticationManagerBuilder auth) throws Exception {
        auth.inMemoryAuthentication()
            .withUser("user1")
            .password("{noop}password1")
            .authorities("ROLE_USER")
            .and()
            .withUser("user2")
            .password("{noop}password2")
            .authorities("ROLE_USER");
    }
}
```

SecurityConfig 클래스는 간단히 말해 사용자의 HTTP 요청 경로에 대해 접근 제한과 같은 보안 관련 처리를 우리가 원하는대로 할 수 있게 해준다. 자세한 내용은 진도를 나간 이후에 알게 될 것이다.  

일단, 타코 클라우드 애플리케이션을 실행하고 웹 브라우저에서 http://localhost:8080으로 접속하자.  SecurityConfig 클래스의 configure() 메서드에서 모든 사용자의 홈페이지 접근을 허용했기 때문에 홈페이지가 바로 나타날 것이다. 그다음에 http://localhost:8080/design에 접속해 보자. 이번에는 스프링 시큐리티의 HTTP 기본 인증 대화상자 대신 다른 HTTP 로그인 대화상자가 나타날 것이다. 

사용자 이름에는 "user1", 비밀번호 필드에는 "password1"을 입력하고 로그인을 클릭하면 타코 디자인 폼이 나타날 것이다. 우리는 여기서 더 나아가 실제로 애플리케이션에서 사용할 만한 로그인 페이지를 새로 생성할 것이다. (앞의 코드에서는 비밀번호를 암호화하지 않았지만 실제로는 반드시 해야 한다.)

타코 클라우드 애플리케이션의 로그인 페이지를 생성하고 보안을 구성하기에 앞서 먼저 할 일이 있다. 한 명 이상의 사용자를 처리할 수 있도록 사용자 정보를 유지, 관리하는 **사용자 스토어** 를 구성하는 것이다. 스프링 시큐리티에서는 여러 가지의 사용자 스토어 구성 방법을 제공한다.

- 인메모리(in-memory) 사용자 스토어
- JDBC 기반 사용자 스토어
- LDAP 기반 사용자 스토어
- 커스텀 사용자 명세 서비스

잠시 앞에서 작성한 SecurityConfig 클래스를 다시 살펴보자. 이는 보안 구성 클래스인 WebSecurityConfigurerAdapter의 서브 클래스이다. 그리고 두 개의 configure() 메서드를 오버라이딩 하고 있다. **configure(HttpSecurity)** 는 **HTTP 보안을 구성하는 메서드** 이다. 그리고 **configure(AuthenticationManagerBuilder)** 는 **사용자 인증 정보를 구성하는 메서드** 이며, 위의 사용자 스토어 중 어떤 것을 선택하든 이 메서드에서 구성한다. 

우선, configure(AuthenticationManagerBuilder) 메서드를 오버라이딩하여 **사용자 스토어를 구성** 하는 방법부터 알아보자.

```java
@Override
public void configure(AuthenticationManagerBuilder auth) throws Exception {
    ...
}
```

이 configure() 메서드에는 인증을 하기 위해 사용자를 찾는 방법을 지정하는 코드를 작성해야 한다. 이때 인자로 전달된 AuthenticationManagerBuilder를 사용한다. 인메모리 사용자 스토어를 구현하는 방법은 다음과 같다.

## 4.2.1 인메모리 사용자 스토어(p123~125)

사용자 정보를 유지 및 관리할 수 있는 곳 중 하나가 메모리다. 만약 변경이 필요 없는 사용자만 미리 정해 놓고 애플리케이션을 사용한다면 아예 보안 구성 코드 내부에 사용자들을 정의할 수 있을 것이다.

예를 들어, "user1"과 "user2"라는 사용자를 인메모리 사용자 스토어에 구성하는 방법을 보여준다. 

```java
...
@Override
protected void configure(AuthenticationManagerBuilder auth) throws Exception {
    auth.inMemoryAuthentication()
        .withUser("user1")
        .password("{noop}password1")
        .authorities("ROLE_USER")
        .and()
        .withUser("user2")
        .password("{noop}password2")
        .authorities("ROLE_USER");
}
```

타코 애플리케이션이 실행되는 상태에서 http://localhost:8080/design에 접속하면 로그인 대화상자가 나타난다(웹 브라우저의 프라이버시 모드에서 실행하자). 사용자 이름에 "user1", 비밀번호에 "password1"을 입력하고 로그인 버튼을 클릭하면 정상적으로 인증되어 타코 디자인 폼이 나타날 것이다. 만약 보안과 관련하여 변경을 했을 때는 현재 창을 닫고 다시 프라이버시 모드로 새 창을 열어 테스트하는 것이 좋다.

AuthenticationManagerBuilder는 인증 명세를 구성하기 위해 빌더 형태의 API를 사용한다. 이때 **inMemoryAuthentication()** 메서드를 사용하여 보안 구성 자체에 사용자 정보를 직접 지정할 수 있다.

withUser()를 호출하면 해당 사용자의 구성이 시작되며, 이때 사용자 이름(username)을 인자로 전달한다. 한편 비밀번호(password)와 부여 권한(granted authority)는 각각 password()와 authorities() 메서드의 인자로 전달하여 호출한다.(.authorities("ROLE_USER") 대신 .roles("USER")를 사용해도 된다). 그리고 and() 메서드로 연속해서 withUser()를 호출하여 여러 사용자를 지정할 수 있다. 

스프링 5부터는 반드시 비밀번호를 암호화해야 한다. 만약 password() 메서드를 호출하여 암호화하지 않으면 접근 거부(HTTP 403) 또는 Internal Server Error(HTTP 500)가 발생한다. 그러나 인메모리 사용자 스토어의 간단한 테스트를 위해 위 코드에서는 {noop}를 지정하여 비밀번호를 암호화하지 않았다.

인메모리 사용자 스토어는 테스트 목적이나 간단한 애플리케이션은 편리하다. 하지만 사용자 정보 추가 및 변경이 쉽지 않다. 이런 점 때문에 고객 스스로 사용자로 등록하고 정보를 변경하는 타코 클라우드 애플리케이션에서는 인메모리 사용자 스토어가 적합하지 않다. 다음에서는 데이터베이스로 지원되는 사용자 스토어를 알아보도록 하자.

## 4.2.2 JDBC 기반의 사용자 스토어(p125)

사용자 정보는 관계형 데이터베이스로 유지 및 관리되는 경우가 많기 때문에 JDBC 기반의 사용자 스토어가 적합해 보인다. 다음에서는 관계형 데이터베이스에 유지되는 사용자 정보를 인증하기 위해 JDBC를 사용하여 스프링 시큐리티를 구성하는 방법을 보여준다.

```JAVA
...
import javax.sql.DateSource;
...

@Autowired
DataSource dataSource;

@Override
protected void configure(AuthenticationManagerBuilder auth) throws Exception {
    auth
        .jdbcAuthentication()
        .dataSource(dataSource);
}
```

configure()에서는 AuthenticationManagerBuilder의 jdbcAuthentication()을 호출한다. 이때 데이터베이스를 접근하는 방법을 알 수 있도록 dataSource() 메서드를 호출하여 DataSource도 설정해주어야 한다. 여기에서는 @Autowired 애노테이션을 지정했기 때문에 DataSource가 자동으로 주입된다.

## 
